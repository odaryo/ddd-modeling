# Aggregate Advice Reference

Phase 3: 集約特定フェーズの詳細ガイド。

## Aggregate Basics

**集約とは:**
- 一貫性境界（トランザクション境界）
- 外部からは集約ルートを通じてのみアクセス
- 集約内の不変条件を守る

## Good Aggregate Design

### サイズは小さく

**Good:**
- 1つの明確な責任
- 数個のエンティティ/値オブジェクト
- 頻繁に変更されない

**Bad:**
- 巨大な集約（"God Aggregate"）
- 関係ないものが含まれている
- 頻繁にロック競合が起きる

### 集約ルートは1つ

**Good:**
```
Order (集約ルート)
  └── OrderItem (エンティティ)
  └── ShippingAddress (値オブジェクト)
```

**Bad:**
```
Order
OrderItem ← 両方が外部からアクセス可能
```

### 集約間はIDで参照

**Good:**
```
Order.customerId: CustomerId  （IDで参照）
```

**Bad:**
```
Order.customer: Customer  （オブジェクト参照）
```

## Common Issues

### Issue 1: 集約が大きすぎる

**症状:** 多くのエンティティが1つの集約に

**解決:** 本当に同時に変更が必要か確認。別々で良いなら分割。

### Issue 2: 集約間の整合性

**症状:** 「AとBを同時に更新しないと整合性が取れない」

**解決:**
- 本当に同時か確認 → 同じ集約にする
- 結果整合性で良いか確認 → イベント駆動に

### Issue 3: 頻繁な集約間通信

**症状:** 毎回他の集約を参照

**解決:**
- リードモデルで必要なデータを集約
- 集約境界の見直し

## Questions to Ask

**境界確認:**
- 「この2つは同時に更新する必要がありますか？」
- 「別々に更新しても問題ないですか？」

**不変条件確認:**
- 「常に守らなければならないルールは何ですか？」
- 「そのルールはどの範囲で守る必要がありますか？」

**ライフサイクル確認:**
- 「これはいつ作成されますか？」
- 「親が削除されたら、子はどうなりますか？」

## Phase Completion Criteria

- [ ] 各集約に明確なルートがある
- [ ] 集約内で不変条件を守れる
- [ ] 集約サイズが適切
- [ ] 集約間の参照はIDのみ

**完了したら:**
「集約が決まりました。境界コンテキストの決定（Phase 4）に進みましょうか？」
